name: Build

# When this action will be executed
on:
  # Automatically trigger it when detected changes in repo
  push:
    branches: 
      [ main ]

  # Allow mannually trigger 
  workflow_dispatch:

env:
  REGISTRY: roelvandegrint.azurecr.io

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        services: [ 
          { 'imageName': 'multi-arch-api', 'directory': '.', 'dockerFile': './Dockerfile' }
        ]
    outputs:
      containerImage-multi-arch-api: ${{ steps.image-tag.outputs.image-multi-arch-api }}
    steps:
      - name: Checkout to the branch
        uses: actions/checkout@v2        

      # https://github.com/docker/setup-qemu-action
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v1
      
      # https://github.com/docker/setup-buildx-action
      - name: Set up Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@v1

      - name: Log in to container registry
        uses: docker/login-action@v1
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      #Build and push Docker image with Buildx (don't push on PR)
      #https://github.com/docker/build-push-action
      - name: Build and push Docker image
        uses: docker/build-push-action@v2
        with:
          tags: ${{ env.REGISTRY }}/${{ matrix.services.imageName }}:${{ github.sha }},${{ env.REGISTRY }}/${{ matrix.services.imageName }}:latest
          file: ${{ matrix.services.dockerFile }}
          context: ${{ matrix.services.directory }}
          platforms: linux/amd64,linux/arm64
          push: true

      - name: Output image tag
        id: image-tag
        run: echo "::set-output name=image-${{ matrix.services.imageName }}::${{ matrix.services.imageName }}:${{ github.sha }}"